# SPC 経費精算システム 技術スタック定義書

## 1. 概要

本ドキュメントは、SPC経費精算システムMVPの開発・運用に使用する技術スタックを定義します。

---

## 2. アーキテクチャ概要

```
┌─────────────────┐
│   フロントエンド  │  (SPA: Single Page Application)
│   React/Next.js  │
└────────┬────────┘
         │ HTTPS
         │ REST API
┌────────▼────────┐
│   バックエンド   │  (API Server)
│  Node.js/Express │
│   or Python/FastAPI │
└────────┬────────┘
         │
    ┌────┴────┬──────────────┐
    │         │              │
┌───▼───┐ ┌──▼───┐    ┌──────▼──────┐
│  DB   │ │ OCR  │    │ SPC会員DB   │
│PostgreSQL│ │Service│    │  (外部連携)  │
└───────┘ └──────┘    └─────────────┘
```

---

## 3. フロントエンド

### 3.1 推奨技術スタック

#### オプションA: Next.js（推奨）
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript
- **UIライブラリ**: React 18+
- **状態管理**: 
  - サーバー状態: React Query / TanStack Query
  - クライアント状態: Zustand または Context API
- **フォーム管理**: React Hook Form + Zod
- **HTTPクライアント**: Axios または Fetch API
- **スタイリング**: 
  - Tailwind CSS
  - shadcn/ui（UIコンポーネント）
- **認証**: NextAuth.js または JWT
- **ファイルアップロード**: react-dropzone

**選定理由**:
- SSR/SSG対応でSEO・パフォーマンスに優れる
- TypeScript標準サポート
- 豊富なエコシステム
- フル版での拡張性が高い

#### オプションB: React + Vite
- **フレームワーク**: React 18+
- **ビルドツール**: Vite
- **言語**: TypeScript
- **ルーティング**: React Router
- **その他**: オプションAと同様

**選定理由**:
- シンプルな構成
- 高速な開発体験
- 軽量

### 3.2 必須機能
- レスポンシブデザイン対応
- アクセシビリティ対応（WCAG 2.1 AA準拠推奨）
- ブラウザ対応: Chrome, Firefox, Safari, Edge（最新2バージョン）

---

## 4. バックエンド

### 4.1 推奨技術スタック

#### オプションA: Node.js + Express（推奨）
- **ランタイム**: Node.js 20 LTS
- **フレームワーク**: Express.js 4.x
- **言語**: TypeScript
- **ORM**: Prisma または TypeORM
- **バリデーション**: Zod または Joi
- **認証**: JWT (jsonwebtoken)
- **ファイルアップロード**: multer
- **API仕様**: OpenAPI 3.0 (Swagger)

**選定理由**:
- JavaScript/TypeScriptで統一可能
- 豊富なライブラリ
- 開発速度が速い
- コミュニティが大きい

#### オプションB: Python + FastAPI
- **ランタイム**: Python 3.11+
- **フレームワーク**: FastAPI
- **ORM**: SQLAlchemy
- **バリデーション**: Pydantic
- **認証**: JWT (python-jose)
- **API仕様**: OpenAPI 3.0 (自動生成)

**選定理由**:
- 自動API仕様生成
- 型安全性が高い
- 非同期処理に優れる
- フル版のAI機能実装に有利

### 4.2 必須機能
- RESTful API設計
- エラーハンドリング
- ログ記録（Winston / Python logging）
- レート制限
- CORS設定

---

## 5. データベース

### 5.1 推奨技術スタック

#### オプションA: PostgreSQL（推奨）
- **バージョン**: PostgreSQL 15+
- **特徴**:
  - リレーショナルデータベース
  - ACID準拠
  - JSON型サポート（将来の拡張性）
  - 全文検索対応（PostgreSQL Full-Text Search）

**選定理由**:
- オープンソース
- 高パフォーマンス
- 拡張性が高い
- フル版での分析機能に有利

#### オプションB: MySQL
- **バージョン**: MySQL 8.0+
- **特徴**: 広く使われているRDBMS

### 5.2 データベース管理
- **マイグレーション**: 
  - Prisma Migrate (Node.jsの場合)
  - Alembic (Pythonの場合)
- **バックアップ**: 日次自動バックアップ
- **接続プール**: 必須

---

## 6. OCR機能

### 6.1 推奨サービス

#### オプションA: Google Cloud Vision API（推奨）
- **特徴**:
  - 高精度なOCR
  - 日本語対応
  - 領収書認識に優れる
  - API形式で簡単に統合可能

**選定理由**:
- 精度が高い
- 日本語対応が優秀
- スケーラブル
- 料金体系が明確

#### オプションB: AWS Textract
- **特徴**:
  - AWSエコシステムとの統合
  - 高精度なOCR
  - 日本語対応

#### オプションC: Tesseract OCR（オープンソース）
- **特徴**:
  - 無料
  - オンプレミス対応
  - 精度はサービスより劣る可能性

**選定理由**:
- コスト削減
- データ外部送信不要

### 6.2 実装方針
- 領収書画像をOCRサービスに送信
- 日付・金額・店舗名を抽出
- 結果をDBに保存
- ユーザーが修正可能なUIを提供

---

## 7. 認証・認可

### 7.1 認証方式

#### SPC会員DB連携方式（要確認）
- **方式A**: OAuth2 / OpenID Connect
  - SPC会員DBがOAuth2プロバイダーとして機能
  - トークンベース認証
- **方式B**: API連携
  - SPC会員DBのAPIを呼び出して認証
  - セッション管理は自システムで実装
- **方式C**: LDAP連携
  - SPC会員DBがLDAP対応している場合

### 7.2 セッション管理
- **JWT (JSON Web Token)**
  - アクセストークン: 短期間（15分〜1時間）
  - リフレッシュトークン: 長期間（7日〜30日）
- **セッションストレージ**: Redis（推奨）またはDB

### 7.3 認可
- **ロールベースアクセス制御 (RBAC)**
  - 会員: 自分の申請のみアクセス可能
  - 事務局: 全申請にアクセス可能
  - 管理者: 全機能にアクセス可能

---

## 8. ファイルストレージ

### 8.1 推奨技術スタック

#### オプションA: AWS S3（推奨）
- **特徴**:
  - スケーラブル
  - 高可用性
  - コスト効率が良い
  - CDN連携可能（CloudFront）

#### オプションB: Google Cloud Storage
- **特徴**: GCPエコシステムとの統合

#### オプションC: ローカルストレージ
- **特徴**: シンプル、コスト削減
- **注意**: バックアップ・スケーラビリティ要検討

### 8.2 実装方針
- 領収書画像をアップロード
- ファイル名: `{application_id}/{receipt_id}.{ext}`
- アクセス制御: 認証済みユーザーのみアクセス可能

---

## 9. 開発環境・ツール

### 9.1 バージョン管理
- **Git**: バージョン管理
- **GitHub / GitLab**: リポジトリホスティング

### 9.2 コード品質
- **Linter**: 
  - ESLint (JavaScript/TypeScript)
  - Pylint (Python)
- **Formatter**: 
  - Prettier (JavaScript/TypeScript)
  - Black (Python)
- **型チェック**: TypeScript / mypy

### 9.3 テスト
- **フロントエンド**: 
  - Jest + React Testing Library
  - Playwright (E2E)
- **バックエンド**: 
  - Jest (Node.js)
  - pytest (Python)
- **APIテスト**: Postman / Insomnia

### 9.4 CI/CD
- **GitHub Actions** または **GitLab CI**
- 自動テスト実行
- 自動デプロイ（ステージング環境）

---

## 10. デプロイ・インフラ

### 10.1 推奨構成

#### オプションA: クラウド（推奨）
- **フロントエンド**: 
  - Vercel (Next.jsの場合)
  - Netlify
  - AWS Amplify
- **バックエンド**: 
  - AWS EC2 / ECS
  - Google Cloud Run
  - Heroku
- **データベース**: 
  - AWS RDS (PostgreSQL)
  - Google Cloud SQL
- **ファイルストレージ**: AWS S3 / Google Cloud Storage

#### オプションB: オンプレミス
- **サーバー**: Linux (Ubuntu Server 22.04 LTS)
- **コンテナ**: Docker + Docker Compose
- **リバースプロキシ**: Nginx
- **SSL証明書**: Let's Encrypt

### 10.2 必須要件
- HTTPS必須（Let's Encrypt推奨）
- 24時間稼働
- 自動バックアップ
- モニタリング・ログ収集

---

## 11. 監視・ログ

### 11.1 ログ管理
- **アプリケーションログ**: 
  - Winston (Node.js)
  - Python logging
- **アクセスログ**: Nginx / Apache
- **ログ集約**: 
  - CloudWatch (AWS)
  - Google Cloud Logging
  - ELK Stack（オンプレミス）

### 11.2 監視
- **アプリケーション監視**: 
  - Sentry（エラー追跡）
  - New Relic / Datadog
- **インフラ監視**: 
  - Prometheus + Grafana
  - CloudWatch

---

## 12. セキュリティ

### 12.1 必須対策
- **HTTPS**: TLS 1.2以上必須
- **認証**: 強力なパスワードポリシー（SPC会員DB側）
- **認可**: ロールベースアクセス制御
- **入力検証**: すべての入力値を検証
- **SQLインジェクション対策**: ORM使用
- **XSS対策**: フレームワークの標準機能
- **CSRF対策**: CSRFトークン
- **セキュアヘッダー**: Helmet.js (Node.js)

### 12.2 データ保護
- **個人情報**: 暗号化保存（必要に応じて）
- **パスワード**: ハッシュ化（SPC会員DB側で管理）
- **通信**: HTTPS必須

---

## 13. パフォーマンス要件

### 13.1 レスポンス時間
- **目標**: 3秒以内（要件定義より）
- **最適化**:
  - データベースインデックス
  - キャッシュ（Redis推奨）
  - 画像最適化
  - CDN利用（静的ファイル）

### 13.2 スケーラビリティ
- 水平スケーリング対応設計
- ステートレスなAPI設計
- データベース接続プール

---

## 14. 技術スタック決定フロー

### 14.1 決定が必要な項目

1. **フロントエンド**: Next.js vs React + Vite
2. **バックエンド**: Node.js vs Python
3. **データベース**: PostgreSQL vs MySQL
4. **OCRサービス**: Google Cloud Vision API vs AWS Textract vs Tesseract
5. **ファイルストレージ**: AWS S3 vs Google Cloud Storage vs ローカル
6. **デプロイ環境**: クラウド vs オンプレミス
7. **SPC会員DB連携方式**: OAuth2 vs API連携 vs LDAP

### 14.2 決定基準

- **コスト**: 初期費用・運用費用
- **開発速度**: チームのスキルセット
- **拡張性**: フル版への拡張を考慮
- **保守性**: 長期的なメンテナンス
- **セキュリティ**: セキュリティ要件の満足度

---

## 15. 推奨構成（MVP）

### 15.1 最小構成（推奨）

```
フロントエンド: Next.js 14 + TypeScript + Tailwind CSS
バックエンド: Node.js 20 + Express + TypeScript
データベース: PostgreSQL 15
OCR: Google Cloud Vision API
認証: JWT + SPC会員DB API連携
ファイルストレージ: AWS S3
デプロイ: Vercel (Frontend) + AWS EC2/ECS (Backend)
```

### 15.2 理由

- **開発速度**: TypeScriptで統一、開発効率が高い
- **コスト**: MVP段階では最小限のコスト
- **拡張性**: フル版への拡張が容易
- **保守性**: 一般的な技術スタックで保守しやすい

---

## 16. 次のステップ

1. **技術スタックの最終決定**
   - 上記の推奨構成をベースに検討
   - SPC会員DB連携方式の確認が必要

2. **開発環境構築**
   - ローカル開発環境のセットアップ
   - Docker Composeでの環境構築（推奨）

3. **プロジェクト初期化**
   - リポジトリ作成
   - プロジェクト構成の決定

---

## 17. 参考資料

- [Next.js Documentation](https://nextjs.org/docs)
- [Express.js Documentation](https://expressjs.com/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Google Cloud Vision API](https://cloud.google.com/vision/docs)
- [OpenAPI Specification](https://swagger.io/specification/)
