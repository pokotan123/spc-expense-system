# SPC 経費精算システム デプロイ手順書

## 1. アーキテクチャ概要

```
┌─────────────────┐
│   Vercel        │  フロントエンド（Next.js）
│   (Frontend)    │
└────────┬────────┘
         │ HTTPS
         │ REST API
┌────────▼────────┐
│   Railway       │  バックエンド（Node.js/Express）
│   (Backend API) │
└────────┬────────┘
         │
    ┌────┴────┐
    │        │
┌───▼───┐ ┌──▼───┐
│Railway│ │ OCR  │
│PostgreSQL│ │Service│
└───────┘ └──────┘
```

---

## 2. 前提条件

### 2.1 必要なアカウント
- **GitHub**: リポジトリホスティング
- **Vercel**: フロントエンドデプロイ
- **Railway**: バックエンド・データベースデプロイ
- **Google Cloud**: OCRサービス（Google Cloud Vision API使用の場合）

### 2.2 必要なツール
- Git
- Node.js 20 LTS（ローカル開発用）
- npm または yarn

---

## 3. プロジェクト構成

### 3.1 推奨リポジトリ構成

```
spc-expense-system/
├── frontend/              # Next.js フロントエンド
│   ├── .env.local
│   ├── .env.example
│   ├── next.config.js
│   ├── package.json
│   └── ...
├── backend/              # Node.js/Express バックエンド
│   ├── .env
│   ├── .env.example
│   ├── package.json
│   ├── Dockerfile
│   └── ...
├── docs/                 # ドキュメント
│   ├── api-specification.yaml
│   ├── database-schema.md
│   └── ...
├── .gitignore
└── README.md
```

### 3.2 モノリポ構成（オプション）

単一リポジトリで管理する場合：

```
spc-expense-system/
├── apps/
│   ├── frontend/
│   └── backend/
├── packages/
│   └── shared/
├── docs/
└── package.json (root)
```

---

## 4. Vercel設定（フロントエンド）

### 4.1 Vercelプロジェクト作成

1. [Vercel](https://vercel.com)にログイン
2. "New Project"をクリック
3. GitHubリポジトリを選択
4. プロジェクト設定:
   - **Framework Preset**: Next.js
   - **Root Directory**: `frontend`（モノリポの場合）
   - **Build Command**: `npm run build`（自動検出）
   - **Output Directory**: `.next`（自動検出）

### 4.2 環境変数設定（Vercel）

Vercelダッシュボードで以下を設定：

```
NEXT_PUBLIC_API_URL=https://your-backend.railway.app/api/v1
NEXT_PUBLIC_APP_URL=https://your-app.vercel.app
```

### 4.3 vercel.json（オプション）

`frontend/vercel.json`:

```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["hnd1"],
  "env": {
    "NEXT_PUBLIC_API_URL": "@api-url"
  }
}
```

---

## 5. Railway設定（バックエンド・データベース）

### 5.1 Railwayプロジェクト作成

1. [Railway](https://railway.app)にログイン
2. "New Project"をクリック
3. "Deploy from GitHub repo"を選択
4. リポジトリとブランチを選択

### 5.2 PostgreSQLデータベース作成

1. Railwayダッシュボードで"New" → "Database" → "Add PostgreSQL"
2. データベースが自動作成される
3. 接続情報を確認（後で環境変数に設定）

### 5.3 バックエンドサービス作成

1. "New" → "GitHub Repo"を選択
2. リポジトリと`backend`ディレクトリを選択
3. Railwayが自動検出:
   - **Build Command**: `npm install`
   - **Start Command**: `npm start`

### 5.4 環境変数設定（Railway）

Railwayダッシュボードで以下を設定：

#### データベース接続
```
DATABASE_URL=${{Postgres.DATABASE_URL}}
```

#### アプリケーション設定
```
NODE_ENV=production
PORT=3000
API_VERSION=v1
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d
```

#### OCR設定（Google Cloud Vision API）
```
GOOGLE_CLOUD_PROJECT_ID=your-project-id
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json
# または環境変数で直接設定
GOOGLE_CLOUD_KEY_FILE=base64-encoded-credentials
```

#### ファイルストレージ（AWS S3）
```
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_REGION=ap-northeast-1
AWS_S3_BUCKET_NAME=spc-expense-receipts
```

#### SPC会員DB連携（要確認）
```
SPC_MEMBER_DB_API_URL=https://spc-member-db.example.com/api
SPC_MEMBER_DB_API_KEY=your-api-key
```

#### CORS設定
```
CORS_ORIGIN=https://your-app.vercel.app
```

### 5.5 Railway設定ファイル

`backend/railway.json`:

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm install"
  },
  "deploy": {
    "startCommand": "npm start",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### 5.6 Dockerfile（オプション）

`backend/Dockerfile`:

```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

---

## 6. 環境変数管理

### 6.1 ローカル開発用（.env.example）

#### frontend/.env.example
```env
NEXT_PUBLIC_API_URL=http://localhost:3000/api/v1
NEXT_PUBLIC_APP_URL=http://localhost:3001
```

#### backend/.env.example
```env
NODE_ENV=development
PORT=3000
DATABASE_URL=postgresql://user:password@localhost:5432/spc_expense
JWT_SECRET=development-secret-key
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d
GOOGLE_CLOUD_PROJECT_ID=your-project-id
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_REGION=ap-northeast-1
AWS_S3_BUCKET_NAME=spc-expense-receipts-dev
CORS_ORIGIN=http://localhost:3001
```

### 6.2 環境変数の優先順位

1. Railway/Vercelの環境変数設定
2. `.env.local`（ローカル開発）
3. `.env`（デフォルト値）

---

## 7. デプロイ手順

### 7.1 初回デプロイ

#### ステップ1: リポジトリ準備
```bash
# リポジトリをクローン
git clone https://github.com/your-org/spc-expense-system.git
cd spc-expense-system

# ブランチ作成
git checkout -b main
```

#### ステップ2: データベースセットアップ（Railway）
1. RailwayでPostgreSQLを作成
2. 接続情報を取得
3. マイグレーション実行:
   ```bash
   cd backend
   npm run migrate
   ```

#### ステップ3: バックエンドデプロイ（Railway）
1. Railwayでバックエンドサービスを作成
2. GitHubリポジトリを接続
3. 環境変数を設定
4. デプロイが自動実行される

#### ステップ4: フロントエンドデプロイ（Vercel）
1. Vercelでプロジェクトを作成
2. GitHubリポジトリを接続
3. 環境変数を設定（`NEXT_PUBLIC_API_URL`にRailwayのURLを設定）
4. デプロイが自動実行される

### 7.2 継続的デプロイ（CI/CD）

#### GitHub Actions（オプション）

`.github/workflows/deploy.yml`:

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Railway
        run: |
          # Railway CLIを使用してデプロイ
          # またはRailwayのGitHub連携を使用
          
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./frontend
```

---

## 8. ドメイン設定

### 8.1 Vercel（フロントエンド）

1. Vercelダッシュボード → Settings → Domains
2. カスタムドメインを追加
3. DNS設定を実施

### 8.2 Railway（バックエンド）

1. Railwayダッシュボード → Settings → Networking
2. "Generate Domain"をクリック
3. カスタムドメインを設定（オプション）

---

## 9. セキュリティ設定

### 9.1 HTTPS

- **Vercel**: 自動でHTTPS対応
- **Railway**: 自動でHTTPS対応

### 9.2 CORS設定

バックエンドでCORSを適切に設定：

```javascript
// backend/src/app.js
const cors = require('cors');

app.use(cors({
  origin: process.env.CORS_ORIGIN || 'https://your-app.vercel.app',
  credentials: true
}));
```

### 9.3 環境変数の保護

- 機密情報は環境変数で管理
- `.env`ファイルはGitにコミットしない
- Railway/Vercelの環境変数設定を使用

---

## 10. 監視・ログ

### 10.1 Vercel

- Vercelダッシュボードでログ確認
- Analytics有効化（オプション）

### 10.2 Railway

- Railwayダッシュボードでログ確認
- メトリクス監視

### 10.3 エラー追跡

- Sentryなどのエラー追跡サービスを統合（推奨）

---

## 11. トラブルシューティング

### 11.1 よくある問題

#### バックエンドに接続できない
- CORS設定を確認
- 環境変数`NEXT_PUBLIC_API_URL`を確認
- Railwayのログを確認

#### データベース接続エラー
- `DATABASE_URL`環境変数を確認
- RailwayのPostgreSQL接続情報を確認
- マイグレーションが実行されているか確認

#### OCRが動作しない
- Google Cloud Vision APIの認証情報を確認
- クレデンシャルファイルのパスを確認
- APIキーの権限を確認

### 11.2 ログ確認方法

#### Vercel
```bash
vercel logs
```

#### Railway
- Railwayダッシュボード → サービス → Logs

---

## 12. コスト見積もり

### 12.1 Vercel

- **Hobby Plan**: 無料（個人プロジェクト）
  - 100GB帯域幅/月
  - 無制限のデプロイ
- **Pro Plan**: $20/月（チーム向け）

### 12.2 Railway

- **Hobby Plan**: $5/月
  - $5のクレジット
  - PostgreSQL: $5/月
- **Pro Plan**: $20/月
  - $20のクレジット

### 12.3 その他

- Google Cloud Vision API: 使用量に応じて課金
- AWS S3: 使用量に応じて課金

---

## 13. 次のステップ

1. **リポジトリ作成**: GitHubでリポジトリを作成
2. **プロジェクト初期化**: フロントエンド・バックエンドのプロジェクトを作成
3. **環境変数設定**: 必要な環境変数を準備
4. **初回デプロイ**: 上記手順に従ってデプロイ
5. **動作確認**: 各機能が正常に動作するか確認

---

## 14. 参考資料

- [Vercel Documentation](https://vercel.com/docs)
- [Railway Documentation](https://docs.railway.app)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [PostgreSQL on Railway](https://docs.railway.app/databases/postgresql)
