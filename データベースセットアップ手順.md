# データベースセットアップ手順

## 📋 概要

SPC経費精算システムのデータベース（PostgreSQL）をセットアップする手順です。

## 🗄️ 前提条件

- PostgreSQLがインストールされていること
- Node.jsとnpmがインストールされていること

## 🚀 セットアップ手順

### 1. PostgreSQLのインストール（未インストールの場合）

#### macOS (Homebrew)
```bash
brew install postgresql@14
brew services start postgresql@14
```

#### Ubuntu/Debian
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
```

#### Windows
[PostgreSQL公式サイト](https://www.postgresql.org/download/windows/)からインストーラーをダウンロードしてインストール

### 2. データベースの作成

PostgreSQLに接続してデータベースを作成します。

```bash
# PostgreSQLに接続
psql -U postgres

# データベースを作成
CREATE DATABASE spc_expense;

# ユーザーを作成（オプション）
CREATE USER spc_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE spc_expense TO spc_user;

# 接続を終了
\q
```

### 3. 環境変数の設定

バックエンドの`.env`ファイルにデータベース接続URLを設定します。

```bash
cd spc-expense-system/apps/backend
cp .env.example .env
```

`.env`ファイルを編集：

```env
DATABASE_URL=postgresql://spc_user:your_password@localhost:5432/spc_expense?schema=public
```

**接続URLの形式**:
```
postgresql://[ユーザー名]:[パスワード]@[ホスト]:[ポート]/[データベース名]?schema=public
```

### 4. Prismaクライアントの生成

```bash
cd spc-expense-system/apps/backend
npm run generate
```

### 5. マイグレーションの実行

```bash
npm run migrate:dev
```

このコマンドで：
- データベーススキーマが作成されます
- 全8テーブルが作成されます
- インデックスが設定されます

### 6. シードデータの投入

```bash
npm run seed
```

シードデータには以下が含まれます：
- **部門**: 総務部（DEPT001）
- **会員**: 
  - member001（テスト会員）
  - admin001（テスト事務局）
- **社内カテゴリ**:
  - CAT001: 交通費
  - CAT002: 会議費
  - CAT003: 通信費
  - CAT004: 消耗品費
  - CAT999: その他

### 7. 動作確認

データベースに接続してテーブルが作成されているか確認します。

```bash
psql -U spc_user -d spc_expense

# テーブル一覧を表示
\dt

# 会員データを確認
SELECT * FROM members;

# 社内カテゴリを確認
SELECT * FROM internal_categories;

# 接続を終了
\q
```

## 🔄 マイグレーション管理

### 新しいマイグレーションの作成

スキーマを変更した場合：

```bash
# スキーマを編集後
npm run migrate:dev -- --name add_new_field
```

### マイグレーションのリセット（開発環境のみ）

⚠️ **注意**: 本番環境では実行しないでください。すべてのデータが削除されます。

```bash
# マイグレーションをリセット
npx prisma migrate reset

# シードデータを再投入
npm run seed
```

## 🐛 トラブルシューティング

### 接続エラー

**エラー**: `Error: P1001: Can't reach database server`

**解決方法**:
1. PostgreSQLが起動しているか確認
   ```bash
   # macOS
   brew services list
   
   # Linux
   sudo systemctl status postgresql
   ```

2. 接続情報（ホスト、ポート、ユーザー名、パスワード）を確認

### 権限エラー

**エラー**: `Error: P1000: Authentication failed`

**解決方法**:
1. ユーザー名とパスワードを確認
2. PostgreSQLの認証設定を確認（`pg_hba.conf`）

### データベースが存在しない

**エラー**: `Error: P1003: Database does not exist`

**解決方法**:
```bash
psql -U postgres
CREATE DATABASE spc_expense;
```

## 📊 データベース構造

### テーブル一覧

1. **members** - 会員情報
2. **departments** - 部門マスタ
3. **expense_applications** - 経費申請
4. **receipts** - 領収書
5. **ocr_results** - OCR結果
6. **internal_categories** - 社内カテゴリマスタ
7. **application_comments** - 申請コメント
8. **payments** - 振込情報

詳細は `docs/database-schema.md` を参照してください。

## 🚀 Railwayでのセットアップ

Railwayを使用する場合：

1. RailwayでPostgreSQLサービスを作成
2. 接続URLを環境変数に設定
3. マイグレーションを実行

```bash
# Railway CLIを使用する場合
railway run npm run migrate
railway run npm run seed
```

詳細は `docs/デプロイ手順書.md` を参照してください。

## 📝 次のステップ

データベースセットアップが完了したら：

1. バックエンドサーバーを起動
   ```bash
   cd apps/backend
   npm run dev
   ```

2. フロントエンドから接続して動作確認

3. ログインして機能をテスト
   - 会員: `member001` / `password`
   - 事務局: `admin001` / `password`
