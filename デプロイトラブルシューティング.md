# デプロイトラブルシューティング

## 🔴 Vercel（フロントエンド）のデプロイエラー

### 問題1: Root Directoryが見つからない

**エラー**: `Could not find a `package.json` file`

**解決方法**:
1. Vercelダッシュボード → プロジェクト設定
2. 「Settings」→「General」
3. **Root Directory** を `apps/frontend` に設定
4. 「Save」をクリック
5. 「Deployments」タブで「Redeploy」をクリック

### 問題2: ビルドエラー

**エラー**: `Module not found` または `Type error`

**解決方法**:
1. ローカルでビルドが成功するか確認：
   ```bash
   cd apps/frontend
   npm install
   npm run build
   ```
2. エラーがあれば修正してコミット・プッシュ
3. Vercelで再デプロイ

### 問題3: 環境変数が設定されていない

**エラー**: API接続エラー

**解決方法**:
1. Vercelダッシュボード → 「Settings」→「Environment Variables」
2. `NEXT_PUBLIC_API_URL` を追加：
   - 値: `https://your-railway-app.railway.app/api/v1`
3. 「Redeploy」をクリック

---

## 🟡 Railway（バックエンド）のデプロイエラー

### 問題1: ビルドエラー

**エラー**: `npm run build` が失敗する

**解決方法**:
1. Railwayダッシュボード → バックエンドサービス → 「Settings」
2. **Root Directory** を `apps/backend` に設定
3. **Build Command** を確認：
   ```
   npm install && npm run generate && npm run build
   ```
4. 再デプロイ

### 問題2: サーバーが起動しない

**エラー**: `Port already in use` または `Cannot find module`

**解決方法**:
1. **Start Command** を確認：
   ```
   npm start
   ```
2. 環境変数 `PORT` が設定されているか確認（Railwayは自動設定）
3. `package.json` の `start` スクリプトを確認

### 問題3: データベース接続エラー

**エラー**: `Can't reach database server`

**解決方法**:
1. Railwayダッシュボード → PostgreSQLサービス → 「Variables」
2. `DATABASE_URL` をコピー
3. バックエンドサービスの「Variables」に `DATABASE_URL` を設定
4. 値: `${{Postgres.DATABASE_URL}}` （PostgreSQLサービス名に合わせて調整）

### 問題4: Prismaクライアントが生成されない

**エラー**: `@prisma/client did not initialize yet`

**解決方法**:
1. **Build Command** に `npm run generate` が含まれているか確認
2. 正しい順序: `npm install && npm run generate && npm run build`

---

## 🔵 データベースマイグレーション

### マイグレーションが実行されていない

**問題**: テーブルが存在しない

**解決方法**:

#### 方法1: Railway CLIを使用

```bash
# Railway CLIをインストール
npm install -g @railway/cli

# ログイン
railway login

# プロジェクトを選択
railway link

# マイグレーション実行
railway run npm run migrate

# シードデータ投入
railway run npm run seed
```

#### 方法2: Railwayダッシュボードから

1. バックエンドサービスの「Settings」→「Deploy」
2. **Deploy Command** を一時的に変更：
   ```
   npm run migrate && npm start
   ```
3. デプロイを実行
4. マイグレーション完了後、**Deploy Command** を `npm start` に戻す

---

## 🟢 環境変数の設定

### Vercel（フロントエンド）

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `NEXT_PUBLIC_API_URL` | `https://xxx.railway.app/api/v1` | RailwayのバックエンドURL |

### Railway（バックエンド）

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `DATABASE_URL` | `${{Postgres.DATABASE_URL}}` | PostgreSQLの接続URL |
| `JWT_SECRET` | （ランダム文字列） | JWT署名用の秘密鍵 |
| `PORT` | `3001` | サーバーポート（Railwayが自動設定） |
| `CORS_ORIGIN` | `https://xxx.vercel.app` | VercelのURL |
| `NODE_ENV` | `production` | 環境設定 |

**JWT_SECRETの生成**:
```bash
openssl rand -base64 32
```

---

## 🔍 ログの確認方法

### Vercel

1. Vercelダッシュボード → プロジェクト
2. 「Deployments」タブ
3. デプロイメントをクリック
4. 「Build Logs」または「Function Logs」を確認

### Railway

1. Railwayダッシュボード → サービス
2. 「Deployments」タブ
3. デプロイメントをクリック
4. 「View Logs」をクリック

---

## ✅ チェックリスト

デプロイ前に確認：

- [ ] GitHubにコードがプッシュされている
- [ ] ローカルでビルドが成功する
- [ ] 環境変数が正しく設定されている
- [ ] Root Directoryが正しく設定されている
- [ ] Build Commandが正しい
- [ ] Start Commandが正しい
- [ ] データベースが作成されている
- [ ] マイグレーションが実行されている

---

## 📞 サポート

問題が解決しない場合：

1. エラーログを確認
2. 上記のトラブルシューティングを試す
3. Vercel/Railwayのドキュメントを参照
4. GitHubのIssuesで問題を報告
